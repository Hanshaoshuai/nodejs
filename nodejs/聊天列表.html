<!DOCTYPE html>
<html lang="en">
	<head>
	    <meta charset="UTF-8">
	    <title>交流列表</title>
		<!-- <script src="routes/index.js" type="text/javascript" charset="utf-8"></script> -->
	    <script type="text/javascript" src="jquery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.dev.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="css/record.css"/>
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<script>
			!function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};return t.m=e,t.c=i,t.p="",t(0)}([function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=window;t["default"]=i.vl=function(e,t){var n=e||100,r=t||750,a=i.document,d=navigator.userAgent,o=d.match(/Android[\S\s]+AppleWebkit\/(\d{3})/i),l=d.match(/U3\/((\d+|\.){5,})/i),s=l&&parseInt(l[1].split(".").join(""),10)>=80,u=a.documentElement,c=1;if(o&&o[1]>534||s){u.style.fontSize=n+"px";var p=a.createElement("div");p.setAttribute("style","width: 1rem;display:none"),u.appendChild(p);var m=i.getComputedStyle(p).width;if(u.removeChild(p),m!==u.style.fontSize){var v=parseInt(m,10);c=100/v}}var f=a.querySelector('meta[name="viewport"]');f||(f=a.createElement("meta"),f.setAttribute("name","viewport"),a.head.appendChild(f)),f.setAttribute("content","width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1");var h=function(){u.style.fontSize=n/r*u.clientWidth*c+"px"};h(),i.addEventListener("resize",h)},e.exports=t["default"]}]);
			// 设置基础字体大小及字体缩放比例
			vl(100, 750);
		</script>
	</head>
	<body>
	    <div class="yijian">
			<div class="xiangmu-header" @click.stop="yijianHind()">
				<span class="xiangmu-left"><img src="" alt="" id='img'></span>
				<font class="xiangmu-left-go"></font>
				<span>聊聊</span>
				<font class="xiangmu-rigth"></font>
				<ul>
					<li>好友</li>
					<li>已注册人员</li>
					<li>发起群聊</li>
					<li>添加好友</li>
					<li>扫一扫</li>
				</ul>
			</div>
			<div class="box box_list">
				<div class="fankiu">
					<div style="width:100%;height:0.9rem; background:#f5f4f9;"></div>
				</div>
				<div class="bottom">
					暂无人员
				</div>
				<div id="gengduo" style="">
					获取更多数据
				</div>
			</div>
			<div class="box box_friend">
				<div class="fankiu" style='padding-top:0.9rem;'></div>
				<div class="bottom">
					暂无好友
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript">
		var listName = [],page = 1,pageSize = 20,socket = io.connect('http://127.0.0.1:8080'),imgIdLoc = [],groupNameLoc = [],
		localName = window.localStorage.getItem('name');
		
		function socketIo(){
			//消息监听
			socket.on('message', function(data) {
				if(data.text){
					console.log(data.text);
					var dom = $('#list_test');
					if(data.text.fromName === localName && data.text.toName !== ''){
						console.log('111',data.text.text);
						// getList1();
					}else if(data.text.toName === localName){
						console.log('222',data.text.text);
						var settime = setTimeout(function(){
							getList1();
							clearTimeout(settime);
						},200);
					}else if(data.text.toName === '' && (data.text.fromName === localName)){
						console.log('333',data.text.text);
						// getList1();
					}
					if(data.text.type === 'groupChat'){
						console.log('444',data.text.text);
						getList1();
						// toDom(data.text.fromName,data.text.text,data.text.dateTime);
					}
				}
			})
			//填充对方的对话框
			function toDom (fromName,text,dateTime){
				console.log('444',fromName,text,dateTime);
				getList1();
				var dom = $('#list_test');
				dom.append("<li style='height:36px;text-align:center;width:100%;color:red;'>时间"+dateTime+"</li>");
				dom.append("<li style='height:36px;'>"+fromName+"在公告："+text+"</li>");
			}
		}
		function getList(){
			// 所有人员列表
			$.ajax({
				type:'get',
				url:'http://127.0.0.1:8080/get2',
				data:{'type':'chat','page':page,'pageSize':pageSize,'buildingGroup':'no'},
				success:function(data){
					console.log(data);
					if(data.code == 200){
						if(data.body.length == 0){
							return;
						}else{
							$('.box_list .bottom').hide();
							$('#gengduo').show();
						}
						var box = $('.box_list .fankiu');
						var dom = '';
						console.log(box)
// 						
						for(var i=0; i<data.body.length; i++){
							var text = "'"+data.body[i].nickName+"'";
							dom += '<div class="content-food border-bottom" onClick="linkFriends('+text+','+data.body[i].name+')">'+
									'<div class="imgas">'+
										'<p>'+
											'<img class="border" src="'+data.body[i].headPortrait+'" alt="" />'+
										'</p>'+
										'<font style="display:none;"></font>'+
									'</div>'+
									'<span>'+data.body[i].nickName+'</span>'+
								'</div>'
						}
						box.append(dom)
						var el_height = box[0].scrollHeight//   ===>  获得滚动条的高度
						box.scrollTop(el_height)//  ===> 设置滚动条的位置，滚动到底部
					}
					page += 1;
				},
				error:function(){
					console.log('error');
				}
			})
		}
		$('#gengduo').on('click',function(){
			// 获取更多联系人
			getList();
		});
		function linkFriends(nickName,name){
			console.log('添加好友验证消息',nickName,name);
			var mymessage=confirm("是否添加"+nickName+"为好友？");
			if(mymessage==true){
				// alert("添加成功");
				toAdd({'addName':nickName, 'fromNumber':localName,'addNumber':name.toString()});
			}else{  
				// alert("JS功能强大，要学习噢!");
			}
		}
		function toAdd(list){
			//添加好友；
			$.ajax({
				type:'post',
				url:'http://127.0.0.1:8080/post4',
				data:list,
				success:function(data){
					console.log(data);
					if(data.code == 200 ){
						//向对方发送添加好友验证消息
						socket.emit('clientmessage', {
							fromName: localName,
							toName: list.addNumber,
							text: {'friend':'no','addName':list.addName}
						})
						$('.box_list').hide();
						$('.box_friend').show();
						var settime = setTimeout(function(){
							getList1();
							clearTimeout(settime);
						},200);
						alert(data.msg);
					}else{
						$('.box_list').hide();
						$('.box_friend').show();
						var settime = setTimeout(function(){
							getList1();
							clearTimeout(settime);
						},200);
						alert(data.msg);
					}
				},
				error:function(){
					console.log('error');
				}
			})
		}
		
		
		
		
		function getList1(location){
			// 好友人员列表
			$.ajax({
				type:'get',
				url:'http://127.0.0.1:8080/get3',
				data:{'name': localName},
				success:function(data){
					console.log(data);
					if(data.code = 200){
						if(data.body.length == 0){
							return;
						}else{
							$('.box_friend .bottom').hide();
							$('#gengduo').show();
						}
						var box = $('.box_friend .fankiu');
						box.html('');
						var dom = '';
						console.log(box);
						for(var i=0; i<data.body.length; i++){
							var text = "'no'",fromName = "'no'",toName = "'no'",newsNumber = '',friendName = '',toNames = '', headPortrait = '', chatRecord = '',toFriends = '',sex = '',
							remarksName = '', myRegion = '';
							friendName = "'"+data.body[i].name+"'";
							toNames = "'"+data.body[i].nickName+"'";
							headPortrait = "'"+data.body[i].headPortrait+"'";
							sex = "'"+data.body[i].sex+"'";
							if(data.body[i].name == localName){
								window.localStorage.setItem('mySex',data.body[i].sex);
								if(data.body[i].myRegion){
									window.localStorage.setItem('myRegion',data.body[i].myRegion);
								}else{
									window.localStorage.setItem('myRegion','');
								}
							}
							for(var e=0; e<data.body[i].linkFriends.length; e++){
								if(data.body[i].linkFriends[e].friendName == localName && data.body[i].linkFriends[e].adopt == 'yes'){
									text = "'yes'";
									fromName = "'"+data.body[i].linkFriends[e].fromName+"'";
									toName = "'"+data.body[i].linkFriends[e].toName+"'";
									newsNumber = data.body[i].linkFriends[e].newsNumber;
									if(data.body[i].linkFriends[e].remarksName){
										remarksName = data.body[i].linkFriends[e].remarksName;
									}
									if(data.body[i].linkFriends[e].chatRecord.addName){
										chatRecord = "来自"+data.body[i].linkFriends[e].toName+'好友请求！'
									}else{
										if(data.body[i].linkFriends[e].chatRecord.friends == 'yes'){
											chatRecord = data.body[i].linkFriends[e].chatRecord.text;
										}else{
											if(data.body[i].linkFriends[e].chatRecord.friends == 'no'){
												chatRecord = '对方拒绝了您的好友请求！';
												toFriends = "'no'";
											}else{
												chatRecord = data.body[i].linkFriends[e].chatRecord;
											}
										}
									}
								}else{
									if(data.body[i].linkFriends[e].friendName == localName){
										fromName = "'"+data.body[i].linkFriends[e].fromName+"'";
										toName = "'"+data.body[i].linkFriends[e].toName+"'";
										newsNumber = data.body[i].linkFriends[e].newsNumber;
										if(data.body[i].linkFriends[e].remarksName){
											remarksName = data.body[i].linkFriends[e].remarksName;
										}
//										remarksName = "'"+data.body[i].linkFriends[e].remarksName+"'";
										if(data.body[i].linkFriends[e].toName == ''){
											if(data.body[i].linkFriends[e].chatRecord.addName){
												chatRecord = "对方还未添加您为好友！请耐心等待...";
											}else{
												if(data.body[i].linkFriends[e].adopt == ''){
													text = "'yes'";
													toFriends = "'no'";
													chatRecord = '对方拒绝了您的好友请求！';
												}else{
													chatRecord = data.body[i].linkFriends[e].chatRecord;
												}
											}
										}else{
											if(data.body[i].linkFriends[e].chatRecord.addName){
												chatRecord = "来自"+data.body[i].linkFriends[e].toName+'的好友请求！'
											}else{
												if(data.body[i].linkFriends[e].adopt == ''){
													text = "'yes'";
													toFriends = "'no'";
													chatRecord = '您拒绝了对方的好友请求！';
												}else{
													chatRecord = data.body[i].linkFriends[e].chatRecord;
												}
											}
										}
									}
									
								}
							}
							var css_b = '',nickName = data.body[i].nickName,nickName1 = "'no'",imga_first = 'block',imga_last = 'none',localNumber = 0,
							nickNameGrou = "'no'",imgList = [],groupChatNumber = null,groupOwner = "'no'";
							if(newsNumber*1 == 0){
								css_b = 'fromumber';
							}else{
								css_b = '';
							}
							// console.log('lllll',toNames)
							if(remarksName !== ''){
								nickName = remarksName;
								nickName1 = "'"+remarksName+"'"
							}
							if(data.body[i].buildingGroupName){
								groupOwner = "'"+data.body[i].groupOwner+"'";
								imgIdLoc.push(data.body[i].imgId);
								groupNameLoc.push(data.body[i].name);
								// console.log('lllll',groupNameLoc)
								localNumber = data.body[i].imgId.length;
								nickName = data.body[i].buildingGroupName;
								nickNameGrou = "'"+nickName+"'";
								for(var q=0; q<localNumber; q++){
									imgList.push(data.body[i].imgId[q].classIcon);
								}
								if(data.body[i].text == ''){
									chatRecord = '可以开始群聊啦！';
								}else{
									chatRecord = data.body[i].text;
								}
								imga_first = 'none';
								imga_last = 'block';
								groupChatNumber = data.body[i].name;
								for(var p=0; p<groupChatNumber.length; p++){
									// console.log(groupChatNumber[p].name,'----',groupChatNumber[p].newsNumber)
									if(groupChatNumber[p].name == localName && groupChatNumber[p].newsNumber*1 == 0){
										css_b = 'fromumber';
										break;
									}else if(groupChatNumber[p].name == localName){
										css_b = '';
										newsNumber = groupChatNumber[p].newsNumber*1;
									}
								}
							}
							dom += '<div class="content-food border-bottom" onClick="toChat('+groupOwner+','+localNumber+','+nickNameGrou+','+nickName1+','+text+','+fromName+','+toName+','+friendName+','+toNames+','+headPortrait+','+sex+','+toFriends+')">'+
									'<div class="imgas">'+
										'<p style="display:'+imga_first+'">'+
											'<img class="border" src="'+data.body[i].headPortrait+'" alt="" />'+
										'</p>'+
										'<p style="display:'+imga_last+'">'+
											'<a><img class="border_s" src="'+imgList[0]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[1]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[2]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[3]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[4]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[5]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[6]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[7]+'" alt="" /></a>'+
											'<a><img class="border_s" src="'+imgList[8]+'" alt="" /></a>'+
										'</p>'+
										'<font class="'+css_b+'">'+newsNumber+'</font>'+
									'</div>'+
									'<div class="texts">'+
										'<span class="first">'+nickName+'</span>'+
										'<span class="lalst">'+chatRecord+'</span>'+
									'</div>'+
								'</div>'
						}
						box.append(dom);
						if(location){
							window.location.href = '聊天室.html';
						}
					}
				},
				error:function(){
					console.log('error');
				}
			})
		}
		function claerNumeber(groupOwner,localNumber,nickNameGrou,nickName1,text,fromName,toName,friendName,toNames,headPortrait,sex,toFriends){
			// 消息清零
			window.localStorage.setItem('type','chat');
			window.localStorage.setItem('toChatName',friendName);
			window.localStorage.setItem('toNames',toNames);
			window.localStorage.setItem('nickName',nickName1);
			window.localStorage.setItem('fromName',toName);
			window.localStorage.setItem('headPortrait',headPortrait);
			window.localStorage.setItem('sex',sex);
			getList1('location');
			$.ajax({
				type:'post',
				url:'http://127.0.0.1:8080/post6',
				data:{'fromName':friendName,'myName':localName,'clear':'ok','friends':toFriends},
				success:function(data){
					console.log(data);
					if(data.code == 200 ){
						// alert(data.msg);
					}
				},
				error:function(){
					console.log('error');
				}
			})
		}
		function toChat(groupOwner,localNumber,nickNameGrou,nickName1,text,fromName,toName,friendName,toNames,headPortrait,sex,toFriends){
//			console.log(groupOwner,localNumber,nickNameGrou,nickName1,text,fromName,toName,friendName,toNames,headPortrait,sex,toFriends);
			if(text == 'yes'){
				console.log(toName)
				claerNumeber(groupOwner,localNumber,nickNameGrou,nickName1,text,fromName,toName,friendName,toNames,headPortrait,sex,toFriends);
			}else{
				
				if(text == 'no' && fromName != localName){
					console.log('jkjjjj',toNames.split(',').length);
					if(toNames.split(',').length < 2){
						console.log('jkjjjj',toNames);
						claerNumeber(groupOwner,localNumber,nickNameGrou,nickName1,text,fromName,toName,friendName,toNames,headPortrait,sex,toFriends);
						return;
					}
					// console.log(friendName,toNames);
					for(var i=0; i<imgIdLoc.length; i++){
						if(imgIdLoc[i].length == localNumber){
							window.localStorage.setItem('imgIdLoc',JSON.stringify(imgIdLoc[i]));
							window.localStorage.setItem('toChatName',JSON.stringify(groupNameLoc[i]));
						}
					}
					window.localStorage.setItem('groupOwner',groupOwner);
					window.localStorage.setItem('localNumber',localNumber);
					window.localStorage.setItem('nickName',nickNameGrou);
					window.localStorage.setItem('type','groupChat');
					// window.localStorage.setItem('toChatName',friendName);
					window.localStorage.setItem('toNames',toNames);
					window.localStorage.setItem('fromName',toName);
					window.localStorage.setItem('headPortrait',headPortrait);
					getList1('location');
					// 消息清零
					$.ajax({
						type:'post',
						url:'http://127.0.0.1:8080/post6',
						data:{
							'fromName':localName,
							'myName':window.localStorage.getItem('toChatName'),
							'clear':'ok',
							'friends':toFriends,
							'type': 'groupChat',
							'nickName': nickNameGrou
							},
						success:function(data){
							console.log(data);
							if(data.code == 200 ){
								// alert(data.msg);
							}
						},
						error:function(){
							console.log('error');
						}
					})
					
					
				}else if(fromName != '' && fromName == localName){
					var mymessage=confirm('对方还没有添加你为好友！请耐心等待。');
					if(mymessage==true){
						
					}else{}
				}
			}
		}
		
		$('.xiangmu-left').on('click',function(){
			window.location.href = '个人资料.html';
		})
		function tupian(){
			var x = 0,y = 0;
			$(document).on('click',function(e){
//				console.log(e)
				if (!$(e.target).closest(".xiangmu-rigth,.xiangmu-rigth").length) {
			        $('.xiangmu-header ul').hide().removeAttr('class');
			   }
			})
			$('.xiangmu-rigth').on('click',function(){
				if($('.xiangmu-header ul').attr('class')){
					$('.xiangmu-header ul').hide().removeAttr('class');
				}else{
					$('.xiangmu-header ul').show().attr({'class':'show'});
				}
			})
			$('.xiangmu-left-go').on('click',function(){
				$('.xiangmu-left').show();
				$('.xiangmu-left-go').hide();
				$('.box_list').hide();
				$('.box_friend').show();
				getList1();
				$('.xiangmu-header ul').hide().removeAttr('class');
			})
			$('.xiangmu-header ul li').on('click',function(){
				if(this.innerText == '好友'){
					console.log(this.innerText);
					$('.box_list').hide();
					$('.box_friend').show();
					getList1();
					$('.xiangmu-header ul').hide().removeAttr('class');
				}else if(this.innerText == '已注册人员'){
					console.log(this.innerText);
					$('.box_friend').hide();
					$('.box_list').show();
					$('.xiangmu-left').hide();
					$('.xiangmu-left-go').show();
					if(x == 0){
						getList();
					}
					x+=1;
					$('.xiangmu-header ul').hide().removeAttr('class');
				}else if(this.innerText == '发起群聊'){
					console.log(this.innerText);
					$('.xiangmu-header ul').hide().removeAttr('class');
					window.location.href = '建群页面.html';
				}else if(this.innerText == '添加好友'){
					console.log(this.innerText);
					$('.xiangmu-header ul').hide().removeAttr('class');
					window.location.href = '搜索.html';
				}else if(this.innerText == '扫一扫'){
					console.log(this.innerText);
					$('.xiangmu-header ul').hide().removeAttr('class');
				}
			});
			
// 			$.ajax({
// 				type:'POST',
// 				url:'http://127.0.0.1:8080/post0',
// 				data:{'name':localName},
// 				success:function(data){
// 					console.log(data);
					// if(data.code = 200){
						if(localName && localName !== ''){
							var list = {'imgId':window.localStorage.getItem('imgId')};
							list.id = localName;
							$('#btn').css({'display':'block'});
							$.ajax({
								type:'get',
								url:'http://127.0.0.1:8080/get',
								data:list,
								success:function(data){
									console.log(data);
									if(data.code == 200 ){
										$('#img').attr('src',data.body[0].classIcon);
										window.localStorage.setItem('myHeadPortrait',data.body[0].classIcon);
										getList1();
										socketIo();
									}
								},
								error:function(){
									console.log('error');
								}
							})
// 							$.ajax({
// 								type:'get',
// 								url:'http://127.0.0.1:8080/get1',
// 								data:{'type':'chat'},
// 								success:function(data){
// 									console.log(data);
// 									if(data.code = 200){
// 										var dom = $('#list_test');
// 										for(var i=0; i<data.body.length; i++){
// 											if(data.body[i].fromName === localName && (data.body[i].toName !== '')){
// 												dom.append("<li style='height:36px;text-align:center;width:100%;color:red;'>时间"+data.body[i].dateTime+"</li>");
// 												dom.append("<li style='height:36px;text-align:right;width:100%;'>"+data.body[i].text+"</li>");
// 											}else if(data.body[i].toName === '' && data.body[i].fromName === localName){
// 												dom.append("<li style='height:36px;text-align:center;width:100%;color:red;'>时间"+data.body[i].dateTime+"</li>");
// 												dom.append("<li style='height:36px;text-align:right;width:100%;'>"+data.body[i].fromName+"在公告："+data.body[i].text+"</li>");
// 											}else if(data.body[i].toName === '' && data.body[i].fromName !== localName){
// 												dom.append("<li style='height:36px;text-align:center;width:100%;color:red;'>时间"+data.body[i].dateTime+"</li>");
// 												dom.append("<li style='height:36px;'>"+data.body[i].fromName+"在公告："+data.body[i].text+"</li>");
// 											}else if(data.body[i].toName === localName){
// 												dom.append("<li style='height:36px;text-align:center;width:100%;color:red;'>时间"+data.body[i].dateTime+"</li>");
// 												dom.append("<li style='height:36px;'>"+data.body[i].text+"</li>");
// 											}
// 										}
// // 										var el_height = dom[0].scrollHeight//   ===>  获得滚动条的高度
// // 										dom.scrollTop(el_height)//  ===> 设置滚动条的位置，滚动到底部
// 									}
// 								},
// 								error:function(){
// 									console.log('error');
// 								}
// 							})
						}
					// }
				// },
// 				error:function(){
// 					console.log('error');
// 				}
// 			})
		};
	    (function getText(){
			tupian();
	    })();
	</script>
</html>